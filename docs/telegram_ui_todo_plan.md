# План доработки UI Telegram-бота (в соответствии с docs/userflow_mermaid.md)

Источник: docs/userflow_mermaid.md
Цель: реализовать UX и UI-ответы бота строго по потокам и состояниям на схеме.
Формат: To‑do задачи, сгруппированные на 4 блока. Каждая задача должна быть выполнена для RU и EN локалей.

---

## Блок 1 — Онбординг, навигация и настройки

[Область схемы: A → B → C/D → E → F; G, S0 → S1]

- [ ] /start: показать приветствие и объяснение про выбор языка и влияние на обработку материалов (B).
- [ ] Выбор языка RU/EN: показать инлайн‑кнопки и команды `/ru`, `/en`; сохранить выбор в профиле пользователя; обновить контекст локализации (C, D, E).
- [ ] Тексты приветствия на выбранном языке: краткий гид по возможностям, примеры команд, контекстные CTA (F).
- [ ] Глобальная навигация: всегда доступные кнопки/команды `/menu`, `/help` (G). Возврат к последнему экрану с перечнем команд и объяснениями; единый формат справки.
- [ ] Единый шаблон «экрана меню»: список основных действий и их краткие описания (создать/открыть проект, добавить материалы, мои данные, создать Базу Знаний, создать курс, настройки, экспорт).
- [ ] /settings: выбор `target_level` (beginner/intermediate/advanced), `tone` (pragmatic/motivational/charismatic), `language` (ru/en) (S0).
- [ ] Быстрый превью настроек (S1): показать, как меняются заголовки/описания при текущих настройках (без перегруппировок). Кнопка «Назад» к настройкам.
- [ ] Локализация: покрыть все тексты RU/EN; таблица строк, плейсхолдеры, принципы форматирования чисел/дат, эмодзи и знаки препинания.
- [ ] Сохранение состояния: язык, уровень, тон, последний открытый «экран» меню, текущий проект — хранить на уровне пользователя; таймаут для «устаревших» экранов.
- [ ] Обработка повторного /start: показать короткое приветствие и актуальный «экран меню», не разрывая текущий контекст проекта.
- [ ] Ошибки и валидация: единый обработчик ошибок входа (некорректная команда, неизвестная кнопка), локализованные подсказки по исправлению.
- [ ] Логи/метрики: события выбора языка, открытия меню/справки, изменения настроек; доля пользователей, просмотревших превью настроек.

Критерии приемки Блока 1

- [ ] Любая команда ведет к корректному экрану вне зависимости от предшествующих сообщений.
- [ ] При смене языка все последующие тексты и подсказки — на выбранном языке.
- [ ] /menu всегда возвращает к последнему валидному «экрану меню» с локализованным списком команд.
- [ ] /settings предоставляет живую предпросмотр‑витрину (без перегруппировок), и выход назад сохраняет выборы.

## Блок 2 — Проекты, добавление и управление материалами

[Область схемы: H → H1 → H2 → H3 → ES0; I → I1 → I2 → I3; J, K → K1 → M1..M4 → N1..N4 → P → Q → R/S → T; JD1..JD4; EM → EM1; U/V, U1/V1]

- [x] /create_project (H): запросить имя проекта (H1), подтвердить создание (H2), показать инструкцию «как работать в проекте» и ограничения (H3).
- [x] (ES0): показать CTA «Добавьте 5–10 материалов, чтобы собрать черновую структуру курса»; кнопка перехода в «Добавить материалы».
- [x] /open_project (I): показать список проектов (I1) мини‑меню с кнопками `/projectX` (I2); подтверждение «Проект <name> открыт!» (I3) и переход в ES0.
- [x] /my_data (J): кнопка доступна только если есть загруженные данные; открыть список источников с превью (заголовок/первые строки/тип) (JD1).
- [ ] Фильтры списка (JD2): тип (видео/текст/ссылка), время добавления; отрисовать активные фильтры; «сбросить фильтры».
- [ ] Действия в списке (JD3, JD4): удалить материал из проекта, открыть источник (показать полный текст/метаданные/thumbnail/длительность и т.п.). Подтверждение удаления.
- [x] /add_materials (K): экран выбора типа материалов (K1): image, audio/voice, text, video (M1..M4).
- [ ] Инструкции по каждому типу (N1..N4):
      • image — прикрепить/переслать изображение;
      • audio/voice — записать голос/переслать, либо .mp3/.wav;
      • text — напечатать/переслать сообщение;
      • video — прикрепить файл или прислать ссылку YouTube.
- [x] (P): поддержать до 10 сообщений подряд одного типа в рамках одной «сессии добавления»; визуальный счетчик и подсказка про «Сохранить»/«Добавить еще».
- [ ] После обработки данных: «Данные успешно обработаны!» (Q) с кнопками «Добавить еще» (R → K) и «Сохранить» (S → T).
- [ ] Сохранение (T): сообщение «Все данные сохранены! Теперь можете создать Базу Знаний!» с быстрыми кнопками создания базы/курса в зависимости от условий доступности.
- [ ] Эконом‑режим (EM): при большом объеме материалов показать предложение «Эконом‑режим» (EM1) с объяснением отличий от полного; сохранить выбор режима для проекта.
- [ ] Условия доступности (U/V):
      • Если в проекте нет материалов — ответ «Сначала загрузите материалы» (U1);
      • Если нет базы знаний — ответ «Сначала создайте Базу Знаний» (V1);
      • Иначе показать кнопку «Создать курс» (/create_course) (W)..
- [ ] Ошибки загрузки: недоступная ссылка/некорректный контент/превышен лимит (ST3) — показать, как исправить; кнопка «Попробовать снова».
- [ ] Метрики: объемы добавленных материалов по типам, % пользователей, принявших эконом‑режим, частота удаления источников, CTR по «Добавить еще/Сохранить».

Критерии приемки Блока 2

- [ ] Полный happy‑path: создать проект → добавить 5–10 материалов → сохранить → увидеть предложение создать Базу Знаний.
- [ ] Фильтры и действия списка работают, пагинация/батчи не ломают контекст.
- [ ] Серии до 10 сообщений одного типа корректно считаются и отображаются.
- [ ] Эконом‑режим отображается только при «большом объеме», выбор сохраняется на проект.

---

## Блок 3 — База знаний и курс: предпросмотр, версии, генерация и экспорт

[Область схемы: X → X1 → X2 → X3/X4 → X5 → X6; W → Y00/Y0/Y1 → Y2 → Y3 → Y4; Zacc/Zrev/Zv/Zrb; Z1/Z2 → Z3 → Zexp/Zkit/Zopen → Z4]

- [ ] /create_knowledge_base (X): команда видна только если уже загружены данные (T → X). Экран‑вступление с ожиданиями по результату.
- [ ] Анкета базы (X1): имя базы, основная тема, главный фокус, на чем делать акценты, чего избегать, для кого полезно, позиционирование, дополнительные пожелания. Валидация, сохранение черновика.
- [ ] Создание базы: подтверждение «База знаний успешно создана» (X2); показать действия `/save_base`, `/edit_base` (X3/X4).
- [ ] Загрузка базы (X5 → X6): по `/download_base` отдать ссылку на скачивание; статус и обработка ошибок.
- [ ] /create_course (W): последовательность запросов — рабочее название + «кто ученик» (Y00), затем свободные пожелания (Y0) с примерами (кол-во уроков, чек-листы, банк квизов и т.п.).
- [ ] Построение векторной БД (Y1): индикатор загрузки/прогресса; по завершении — предпросмотр «vision draft», кнопка скачать zip со структурированными заметками; возможность редактировать заметки.
- [ ] Переход к следующему шагу (Y2 → Y3): совместимость со «старой логикой просмотра»; обеспечить обратную совместимость UI.
- [ ] Генерация структуры курса (Y4): с делением на модули/уроки/подтемы; экран предварительного просмотра; возможность «уточнять» структуру через подсказки.
- [ ] Версионирование структуры: `/accept` — зафиксировать версию v1 (Zacc → Zv); `/revise` — разрешать только переименование/перестановку заголовков без перегруппировок (Zrev → Y4); `/rollback` — вернуть к v1, если уже была v2 (Zrb).
- [ ] Продолжение (Z1/Z2): `/edit_course` — обратно к предпросмотру/уточнениям; `/continue` — перейти к генерации материалов по зафиксированной структуре (Z2 → Z3).
- [ ] Генерация курса (Z3): строго по ранее зафиксированной структуре, с использованием материалов из базы знаний; экран «Loading…» (ST1) и прогресс‑индикатор.
- [ ] Экспорт (Zexp/Zkit/Zopen):
      • `/export` — отдать Obsidian vault + mindmap (markmap);
      • `/export_kit` — отдать Course Kit (mindmap, outlines, checklists, workbook, quiz bank, 14‑day content calendar, README);
      • «Открыть в Mini App» — read‑only просмотр артефактов.
- [ ] Успех (Z4): «Курс успешно сгенерирован, теперь можно скачать!» + быстрые кнопки загрузки/открытия.
- [ ] UX‑состояния: предупредить о «слишком мало/низкое качество материалов» (ST2) и предложить добавить 3–5 шт.; обработать ошибки (ST3); успех (ST4) с числом модулей/уроков.
- [ ] Логи/метрики: шаги создания базы/курса, конверсия от предпросмотра к «accept», доля откатов, популярность экспортов и Mini App.

Критерии приемки Блока 3

- [ ] База знаний создается через полную анкету; доступны редактирование, сохранение, скачивание.
- [ ] Структура курса версионируется: «accept/revise/rollback» соблюдают ограничения и корректно меняют активную версию.
- [ ] Генерация курса следует зафиксированной структуре; экспортные форматы доступны и корректно скачиваются/открываются.

---

## Сквозные требования к UI/копирайтингу

- [ ] Единый тон и терминология для RU/EN; согласованность названий команд/кнопок.
- [ ] Сообщения укладываются в лимиты Telegram; длинные тексты — с «Показать больше» через editMessage/пагинацию.
- [ ] � нлайн‑кнопки и reply‑клавиатуры используются последовательно; «всегда доступные» команды дублируются в меню бота.
- [ ] Все критические действия сопровождаются подтверждением и отменой; есть кнопка «Назад».
- [ ] Технические ошибки не «шумят»: лаконичные, с понятной инструкцией, локализованные.

## Технические заметки внедрения (в помощь разработке)

- [ ] Session store: пер‑пользователь/пер‑проект контекст (язык, проект, шаг анкеты, режим эконом, серия добавления материалов, активная версия курса).
- [ ] Компоненты сообщений: переиспользуемые билдеры для Empty/Loading/Warning/Error/Success.
- [ ] Трекинг: события и шаги с атрибутами (язык, проект, тип материала, длительность шага).

---

## Блок 4 — Related tasks

- [x] Persist `target_level` и `tone` на уровне пользователя:
  - Добавлены поля в `users` (`target_level`, `tone`), обновлены `libs/db/models.py`, `libs/db/repositories.py`.
  - Расширен API: `GET/POST /user/settings` для чтения/обновления уровня и тона (защита через `X-Telegram-Init-Data`).
  - Добавлен bot API: `GET/POST /bot/user/settings` (защита через `X-Bot-Api-Token`).
  - В боте: при изменении настроек — вызов API для сохранения; при `/start` — подтягивание сохранённых значений.
- [x] Состояние интерфейса:
  - Хранение `last_menu_msg_id`, `last_screen`, `current_project` в БД (`users`), `ui_state_updated_at`.
  - Bot API: `GET/POST /bot/user/ui_state`; TTL 3600s при чтении (протухшие экраны не возвращаются).
  - Бот обновляет `last_menu_msg_id/last_screen` при открытии `/menu`.
- [x] Обработчик неизвестных команд и валидации: локализованный `/unknown` (MessageHandler(filters.COMMAND)).
- [x] Логи/метрики: логирование событий выбора языка, `/menu`, `/help`, изменений настроек (logger.info; единый sink через стандартный логгер).
- [x] Качество локализации RU: русские описания команд добавлены в новое объявление команд; YAML RU/EN обновлён, добавлены ключи.
- [x] Поведение повторного `/start`: короткое приветствие + возврат к меню (вызов `/menu` после приветствия).
- [ ] Проекты (backend): модель projects (id, user_id, name, created_at), CRUD-репозиторий; связь с пользователем. Эндпоинты Bot API:
  - GET /bot/projects?telegram_id= — список проектов пользователя;
  - POST /bot/projects — создание проекта { telegram_id, name };
  - Адаптация бота: /open_project показывает список из API; /create_project создаёт через API.
- [ ] Ingest: изображения — POST /ingest/image (501→200): вход file или file_id; связать с текущим проектом.
- [ ] Ingest: аудио/voice — POST /ingest/audio (501→200): вход file/file_id,; связать с проектом.
- [ ] Ingest: видео — POST /ingest/video (501→200): вход { source_url } (YouTube),  связать с проектом.
- [ ] /my_data: API для списка загруженных материалов и экспорта/удаления; UI бота — пагинация/фильтры, подтверждения удаления.
- [ ] Счётчики (U/V): API возвращает метрики по проекту (кол-во текстов/изображений/аудио/видео, дата обновления); бот — ES0/ES* показывает «пусто/есть материалы» с количествами.
- [ ] Согласие на эмбеддинги (EM): настройка пользователя (embeddings_opt_in: boolean), первый запуск — модальное подтверждение; хранить в users.
- [ ] Единый хелпер статусов (ST0..ST4): вынести _send_status в утилиту; заменить хардкод в обработчиках; добавить emoji/иконки и ссылки «Попробовать снова».
- [ ] Язык RU: дополнить config/i18n/messages.ru.yaml ключами блока 2 (создано в коде fallback’ом; перенести в YAML при удобном окне изменений).

---

## Блок 1 — Статус выполнения

- [x] /start: приветствие и пояснение про влияние языка на обработку материалов.
- [x] Выбор языка RU/EN: инлайн‑кнопки `/lang` и команды `/ru`, `/en`; сохранение выбора в сессии и API (`/bot/user/lang`).
- [x] Тексты приветствия на выбранном языке.
- [x] Глобальная навигация: доступны `/menu`, `/help`; реализован единый экран меню с перечнем команд и краткими описаниями.
- [x] /settings: выбор `target_level`, `tone`, `language`; быстрый предпросмотр без перегруппировок + «Назад».
- [x] Локализация: покрытие RU/EN всех текстов Блок 1 (i18n YAML), корректный `lang_ru`.
- [x] Сохранение состояния на уровне пользователя: язык/уровень/тон — в БД (через API; бот синхронизирует при изменениях и на старте).
- [x] Ошибки/валидация: добавлен единый обработчик неизвестных команд.
- [x] Логи/метрики: добавлено логирование ключевых событий.

---

## Блок 2 — Статус выполнения

- [x] JD2: /my_data — добавлены фильтр по названию, сортировка по заголовку, переключатель вида (список/сетка).
- [x] JD3, JD4: список с карточками и превью-заглушками; базовая навигация к заметкам. Пагинация — отложена.
- [x] N1..N4: формы добавления материалов в Mini App: изображение, аудио/voice, текст, видео (YouTube URL). Отправка в API /ingest/*.
- [x] ST3: статусы загрузки/успеха/ошибки на страницах Add и My Data.
- [x] Q: навигация — ссылки в шапке на Add и My Data.
- [ ] U/V/W: сценарии создания курса — не реализовано (ожидает спецификацию и API).
- [ ] EM/EM1: opt-in для эмбеддингов — не реализовано (нужен бэкенд и тексты согласия).
- [ ] T: метрики/аналитика — не реализовано (нужна инфраструктура аналитики/логов).
\n## Блок 4 — Related tasks (добавлено)
\n- [ ] Ingest: POST /ingest/text — принимает { text }, создаёт заметку; возвращает { id }.
- [ ] Notes API: расширить ответ /notes — добавить поля type, thumbnail_url, created_at; поддержать пагинацию (limit/cursor) и сортировку (title_asc/desc, created_desc).
- [ ] Search API: поддержать фильтрацию по type для консистентности с /my_data.
- [ ] Analytics: события UI — ingest_submit/success/fail (per type), view_note, export_zip_click, search_performed; HTTP endpoint для приёма событий или интеграция с существующим логированием.
- [ ] i18n (Mini App): убедиться, что ru/en строки для новых экранов согласованы с ботом; централизовать глоссарий терминов.
\n## Блок 2 — Критерии готовности: самопроверка
\n- [x] Happy-path: базовые сценарии добавления материалов через Mini App работают (image/audio/text/video), отображаются статусы, навигация доступна.
- [x] Согласованность навигации и подсказок: добавлены пункты в шапке (Add/My Data), краткие подсказки на формах.
- [ ] 10 сквозных сценариев с ботом: не выполнено в рамках Mini App (нужна интеграция команд бота/бекенда).
- [ ] Приватность/согласия: добавлен общий дисклеймер; opt-in для эмбеддингов и тексты согласия — в планах (см. EM/EM1 в Related tasks).
