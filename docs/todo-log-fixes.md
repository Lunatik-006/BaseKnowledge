# To-Do: Стабилизация БД, API и логирования

## A. Надёжность БД и подключений

- [ ] **A1. Привести в соответствие имя БД между конфигами и фактическим состоянием**
  - **Шаги**
    - [ ] Проинвентаризировать значение имени БД во всех средах (переменные окружения, секреты, миграции, init-скрипты).
    - [ ] Принять «истинное» имя БД и применить одно из: создать БД и обновить конфиги сервиса на корректное имя.
    - [ ] Добавить проверку на старте сервиса: если целевой БД нет или миграции не применены — завершать процесс с явной ошибкой.

- [ ] **A2. Повысить устойчивость пула соединений к рестартам Postgres**
  - **Шаги**
    - [ ] Включить проверку живости соединений в пуле.
    - [ ] Настроить «рецикл» соединений с разумным интервалом.
    - [ ] Добавить ограниченные ретраи с задержкой для ошибок отключения БД, с учётом идемпотентности.

- [ ] **A3. Корректные healthcheck-пробы для Postgres**
  - **Шаги**
    - [ ] Заменить текущие проверки на нативные для Postgres (утилита готовности или эквивалент).
    - [ ] Исключить любые HTTP-пробы к порту 5432.

## B. Корректность API и клиентских вызовов

- [ ] **B1. Ввести строгий контракт на методы и Content-Type**
  - **Шаги**
    - [ ] На уровне API/прокси валидировать метод и тип контента для каждого маршрута.
    - [ ] При несоответствии возвращать корректный статус (415/405) и логировать событие в структурном формате.

## C. Безопасность периметра

- [ ] **C1. Запретить доступ к dotfiles и чувствительным путям**
  - **Шаги**
    - [ ] В конфигурации фронт-сервера/прокси добавить deny-правила для dotfiles и чувствительных путей (`/.git`, `/.env`, `/config/*` и т. п.).
    - [ ] Логировать обращения к запрещённым путям в отдельную категорию безопасности.

- [ ] **C2. Снизить шум от внешних сканеров**
  - **Шаги**
    - [ ] Настроить rate-limit/ban для повторяющихся обращений к запрещённым путям с одного источника.
    - [ ] Добавить дашборд по «пробам периметра» и ежедневный отчёт.

## D. Контракты данных и схемы

- [ ] **D1. Ужесточить JSON-схемы ответов LLM**
  - **Шаги**
    - [ ] Для всех типов объектов запретить дополнительные поля.
    - [ ] Расширить список обязательных полей до реально потребляемых на следующих шагах (insight: id, title, summary, bullets, tags, confidence; topic: topic_id, title, insight_ids; по необходимости — desc).
    - [ ] Включить валидацию на стороне сервиса до перехода к следующему шагу пайплайна; при невалидности — контролируемый отказ/деградация.
  - **Критерии приёмки**
    - [ ] Невалидные ответы отклоняются без падения пайплайна, в логах фиксируется причина (какие поля отсутствуют/лишние).

- [ ] **D2. Генерировать идентификаторы и временные метки на сервере**
  - **Шаги**
    - [ ] Доработать промпты, чтобы поля id/created, присланные LLM были пустыми.
    - [ ] Генерировать идентификаторы и UTC-временные метки на сервере в момент приёма валидного содержимого и добавлять их в соответствующие поля.
    - [ ] Зафиксировать это требование в спецификации пайплайна и документации.

- [ ] **D3. Серверная нормализация пользовательских полей**
  - **Шаги**
    - [ ] Применять нормализацию тегов (kebab-case), ограничение длины заголовков (≤ 80 символов), дедупликацию bullets.
    - [ ] Валидировать и обнулять пустые `source_*`, если модель прислала пустые значения.

## E. Логирование, наблюдаемость и алёрты

- [ ] **E1. Единый формат структурных JSON-логов во всех сервисах**
  - **Шаги**
    - [ ] Утвердить минимальный набор полей: timestamp (UTC), level, service, environment, route, method, status, duration_ms, request_id/correlation_id, user/session (если есть), external.response_id (для внешних интеграций), db.name, error.class/code/message (усечённое), payload_size вход/выход (без содержимого).
    - [ ] Включить одно-строчное логирование и обязательный request_id во всех сообщениях запроса.
  - **Критерии приёмки**
    - [ ] Любое событие находится по request_id во всех сервисах.

## F. Readiness/Liveness и CI/CD

- [ ] **F1. Единый источник правды для конфигурации БД**
  - **Шаги**
    - [ ] Централизовать переменные окружения и секреты (имя БД, хост, порт, пользователь), убрать дубли.
    - [ ] Добавить предварительную проверку конфигурации в CI/CD .
  - **Критерии приёмки**
    - [ ] Деплой блокируется при ошибках конфигурации; дрейфа значений между сервисами нет.

