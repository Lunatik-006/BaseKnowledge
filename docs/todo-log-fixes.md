# To-Do: Стабилизация БД, API и логирования

> Подробный список задач по устранению обнаруженных проблем и внедрению улучшений. Без примеров кода. Отмечайте чекбоксами выполнение задач и подпунктов.

## A. Надёжность БД и подключений

- [ ] **A1. Привести в соответствие имя БД между конфигами и фактическим состоянием**
  - **Шаги**
    - [ ] Проинвентаризировать значение имени БД во всех средах (переменные окружения, секреты, миграции, init-скрипты).
    - [ ] Принять «истинное» имя БД и применить одно из: создать БД и выполнить миграции / обновить конфиги сервиса на корректное имя.
    - [ ] Добавить проверку на старте сервиса: если целевой БД нет или миграции не применены — завершать процесс с явной ошибкой.
  - **Критерии приёмки**
    - [ ] Сервис стартует только при наличии нужной БД и применённых миграций.
    - [ ] В логах отсутствуют ошибки «database does not exist».
    - [ ] Readiness-проба остаётся «not ready», пока БД не готова.

- [ ] **A2. Повысить устойчивость пула соединений к рестартам Postgres**
  - **Шаги**
    - [ ] Включить проверку живости соединений в пуле.
    - [ ] Настроить «рецикл» соединений с разумным интервалом.
    - [ ] Добавить ограниченные ретраи с экспоненциальной задержкой для ошибок отключения БД, с учётом идемпотентности.
  - **Критерии приёмки**
    - [ ] При рестарте Postgres первые запросы не возвращают 500, соединения восстанавливаются прозрачно.
    - [ ] Нет серий одинаковых 500 по `AdminShutdown`/`OperationalError`.

- [ ] **A3. Корректные healthcheck-пробы для Postgres**
  - **Шаги**
    - [ ] Заменить текущие проверки на нативные для Postgres (утилита готовности или эквивалент).
    - [ ] Исключить любые HTTP-пробы к порту 5432.
  - **Критерии приёмки**
    - [ ] В логах Postgres нет записей «invalid length of startup packet».
    - [ ] Мониторинг корректно отражает готовность БД.

- [ ] **A4. Грациозное завершение сервиса при остановке БД**
  - **Шаги**
    - [ ] Настроить обработку завершения: остановить приём новых запросов, дождаться in-flight, закрыть пул коннектов.
    - [ ] В оркестраторе задать preStop/время корректного завершения.
  - **Критерии приёмки**
    - [ ] При остановке БД/сервиса нет резкого скачка 5xx; запросы завершаются контролируемо.

## B. Корректность API и клиентских вызовов

- [ ] **B1. Исправить метод запросов к `/ingest/text` (только POST)**
  - **Шаги**
    - [ ] Найти источники, отправляющие GET на `/ingest/text`.
    - [ ] Обновить клиента/маршрутизацию на корректный метод.
    - [ ] Включить метрику и алерт на рост 405 по маршрутам.
  - **Критерии приёмки**
    - [ ] За 24 часа число 405 по `/ingest/text` = 0.
    - [ ] В мониторинге нет «несанкционированных» методов на маршрут.

- [ ] **B2. Ввести строгий контракт на методы и Content-Type**
  - **Шаги**
    - [ ] На уровне API/прокси валидировать метод и тип контента для каждого маршрута.
    - [ ] При несоответствии возвращать корректный статус (415/405) и логировать событие в структурном формате.
  - **Критерии приёмки**
    - [ ] Неверные методы/контент не доходят до бизнес-логики; события видны в метриках и алёртах.

## C. Безопасность периметра

- [ ] **C1. Запретить доступ к dotfiles и чувствительным путям**
  - **Шаги**
    - [ ] В конфигурации фронт-сервера/прокси добавить deny-правила для dotfiles и чувствительных путей (`/.git`, `/.env`, `/config/*` и т. п.).
    - [ ] Логировать обращения к запрещённым путям в отдельную категорию безопасности.
  - **Критерии приёмки**
    - [ ] Запросы к `/.git*`/`/.env` завершаются 403/404 и фиксируются в логах безопасности.
    - [ ] Нет успешных ответов к этим путям.

- [ ] **C2. Снизить шум от внешних сканеров**
  - **Шаги**
    - [ ] Настроить rate-limit/ban для повторяющихся обращений к запрещённым путям с одного источника.
    - [ ] Добавить дашборд по «пробам периметра» и ежедневный отчёт.
  - **Критерии приёмки**
    - [ ] Число повторных обращений с одного IP по запрещённым путям снижается.
    - [ ] Есть прозрачная видимость по попыткам сканирования.

## D. Контракты данных и схемы

- [ ] **D1. Ужесточить JSON-схемы ответов LLM**
  - **Шаги**
    - [ ] Для всех типов объектов запретить дополнительные поля.
    - [ ] Расширить список обязательных полей до реально потребляемых на следующих шагах (insight: id, title, summary, bullets, tags, confidence; topic: topic_id, title, insight_ids; по необходимости — desc).
    - [ ] Включить валидацию на стороне сервиса до перехода к следующему шагу пайплайна; при невалидности — контролируемый отказ/деградация.
  - **Критерии приёмки**
    - [ ] Невалидные ответы отклоняются без падения пайплайна, в логах фиксируется причина (какие поля отсутствуют/лишние).

- [ ] **D2. Генерировать идентификаторы и временные метки на сервере**
  - **Шаги**
    - [ ] Игнорировать id/created, присланные LLM.
    - [ ] Генерировать идентификаторы и UTC-временные метки на сервере в момент приёма валидного содержимого.
    - [ ] Зафиксировать это требование в спецификации пайплайна и документации.
  - **Критерии приёмки**
    - [ ] Все сохраняемые сущности имеют server-side ID и UTC timestamps единого формата.
    - [ ] В телеметрии доля перезаписанных модельных id/created = 100%.

- [ ] **D3. Серверная нормализация пользовательских полей**
  - **Шаги**
    - [ ] Применять нормализацию тегов (kebab-case), ограничение длины заголовков (≤ 80 символов), дедупликацию bullets.
    - [ ] Валидировать и обнулять пустые `source_*`, если модель прислала пустые значения.
  - **Критерии приёмки**
    - [ ] Сохраняемые записи соответствуют нормам форматирования независимо от ответа модели.

## E. Логирование, наблюдаемость и алёрты

- [ ] **E1. Единый формат структурных JSON-логов во всех сервисах**
  - **Шаги**
    - [ ] Утвердить минимальный набор полей: timestamp (UTC), level, service, environment, route, method, status, duration_ms, request_id/correlation_id, user/session (если есть), external.response_id (для внешних интеграций), db.name, error.class/code/message (усечённое), payload_size вход/выход (без содержимого).
    - [ ] Включить одно-строчное логирование и обязательный request_id во всех сообщениях запроса.
  - **Критерии приёмки**
    - [ ] Любое событие находится по request_id во всех сервисах.
    - [ ] Дашборды и поиск по полям работают одинаково для всех источников логов.

- [ ] **E2. Сквозная корреляция запросов с внешними вызовами**
  - **Шаги**
    - [ ] Прокидывать request_id/correlation_id во внешние вызовы и сохранять их в логах.
    - [ ] Логировать идентификатор ответа внешнего сервиса на каждом вызове.
  - **Критерии приёмки**
    - [ ] По одному request_id видны все связанные записи, включая внешние response_id.

- [ ] **E3. Метрики и алёрты на ключевые сбои**
  - **Шаги**
    - [ ] Ввести счётчики/гистограммы по HTTP-статусам, времени ответа, ошибкам БД, доле 405 по маршрутам, числу невалидных ответов LLM.
    - [ ] Настроить оповещения на всплеск 5xx, рост 405 для `/ingest/text`, появление AdminShutdown/OperationalError, рост невалидных схем.
  - **Критерии приёмки**
    - [ ] Алёрты приходят при заданных порогах и ведут на дашборды с нужными срезами.

- [ ] **E4. Политика редактирования и хранения логов**
  - **Шаги**
    - [ ] Включить маскирование секретов/PII в логах.
    - [ ] Настроить ротацию и сроки хранения по требованиям безопасности/комплаенса.
  - **Критерии приёмки**
    - [ ] В сэмплах логов нет секретов; объём и ретеншн соответствуют политике.

## F. Readiness/Liveness и CI/CD

- [ ] **F1. Readiness-проба API, завязанная на готовность БД**
  - **Шаги**
    - [ ] Реализовать отдельный endpoint готовности, проверяющий: доступность БД, наличие целевой БД и применённых миграций, доступность внешнего провайдера (по необходимости быстрым чек-пингом).
    - [ ] Настроить оркестратор использовать readiness вместо простого TCP-чека.
  - **Критерии приёмки**
    - [ ] Сервис не переходит в «ready», пока зависимости не готовы; трафик не теряется на старте.

- [ ] **F2. Единый источник правды для конфигурации БД**
  - **Шаги**
    - [ ] Централизовать переменные окружения и секреты (имя БД, хост, порт, пользователь), убрать дубли.
    - [ ] Добавить предварительную проверку конфигурации в CI/CD (валидация обязательных переменных и доступности БД целевой среды при деплое).
  - **Критерии приёмки**
    - [ ] Деплой блокируется при ошибках конфигурации; дрейфа значений между сервисами нет.

## G. Верификация после внесения правок

- [ ] **G1. Прогон сценариев отказоустойчивости**
  - **Шаги**
    - [ ] Смоделировать рестарт Postgres под нагрузкой и проверить, что доля 5xx в пределах порога, соединения восстанавливаются.
    - [ ] Проверить отсутствие GET к `/ingest/text`.
    - [ ] Проверить запреты на доступ к dotfiles.
    - [ ] Проверить, что при невалидном ответе LLM пайплайн даёт контролируемый отказ/деградацию, а не падение процесса.
  - **Критерии приёмки**
    - [ ] Все проверки проходят; алёрты не срабатывают при нормальной работе и срабатывают при нарушении порогов.
